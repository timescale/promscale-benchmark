# NOTE: To apply configuration, use `values-override.yaml` instead of this file.
# By doing so you can easily apply your customization changes even after
# `main` branch is updated. This in turn allows for easier `git rebase` operation.

timescaledb-single:
  image:
    repository: ghcr.io/timescale/dev_promscale_extension
    tag: benchmark_rollups-ts2.8.1-pg14
    pullPolicy: Always
  enabled: true
  replicaCount: 1
  backup:
    enabled: false
  persistentVolumes:
    data:
      size: 700Gi
    wal:
      size: 20Gi
  patroni:
    bootstrap:
      dcs:
        postgresql:
          parameters:
            max_locks_per_transaction: 512
  resources:
    requests:
      cpu: 100m
      memory: 2Gi
  tolerations:
  - key: "database"
    operator: "Exists"
    effect: "NoSchedule"
  affinityTemplate: |
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/component
              operator: In
              values:
              - connector
          topologyKey: "kubernetes.io/hostname"
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: topology.timescale.com/zone
            operator: In
            values:
            - database

promscale:
  enabled: true
  # If you want to use a different image, you can do so here.
  image:
    repository: harkishen/promscale
    tag: feature_metric_rollup
    pullPolicy: Always
  extraArgs:
    - "--metrics.high-availability=false"
    - "--startup.upgrade-prerelease-extensions=true"
    - "--metrics.cache.series.initial-size=5000000"
  connectionSecretName: "tobs-promscale-connection"
  resources:
    requests:
      memory: 500Mi
      cpu: 30m
  config:
    # Use 1hr chunk interval for benchmarking. For details https://github.com/timescale/promscale/issues/1736
    startup.dataset.config: |
      metrics:
        default_chunk_interval: 1h
        downsample:
          automatic: true
          resolutions:
          - label: short
            resolution: 5m
            retention: 30d
          - label: long
            resolution: 1h
            retention: 365d
  tolerations:
  - key: "connector"
    operator: "Exists"
    effect: "NoSchedule"
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/component
              operator: In
              values:
              - timescaledb
          topologyKey: "kubernetes.io/hostname"
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: topology.timescale.com/zone
            operator: In
            values:
            - connector

kube-prometheus-stack:
  enabled: true
  defaultRules:
    rules:
      etcd: false
      kubeControllerManager: false
      kubeProxy: false
      kubeScheduler: false
  kubeControllerManager:
    enabled: false
  kubeProxy:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeEtcd:
    enabled: false
  alertmanager:
    enabled: false
  prometheusOperator:
    tls:
      enabled: false
    admissionWebhooks:
      enabled: false
  # This prometheus is monitoring the cluster. Do not use it for load generation.
  prometheus:
    prometheusSpec:
      remoteRead: []
      remoteWrite: []
      replicas: 1
      additionalScrapeConfigsSecret:
        enabled: false
      ruleNamespaceSelector: {}
      serviceMonitorNamespaceSelector: {}
      podMonitorNamespaceSelector: {}
      probeNamespaceSelector: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - timescaledb
              topologyKey: "kubernetes.io/hostname"
          - weight: 50
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/component
                  operator: In
                  values:
                  - connector
              topologyKey: "kubernetes.io/hostname"
  grafana:
    enabled: true
    env:
      GF_AUTH_ANONYMOUS_ENABLED: true
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Editor"
    envValueFrom:
      GRAFANA_PASSWORD:
    prometheus:
      datasource:
        enabled: true
        url: "http://{{ .Release.Name }}-kube-prometheus-stack-prometheus.{{ .Release.Namespace }}.svc:9090"
    timescale:
      datasource:
        enabled: false
opentelemetry-operator:
  enabled: true
